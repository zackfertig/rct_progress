name: Build portable binaries

# Ensure the workflow token can create/update releases
permissions:
  contents: write

on:
  workflow_dispatch: {}
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: ['3.11']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install build deps
        shell: bash
        run: |
          set -euo pipefail
          if [ "${RUNNER_OS:-}" = "Windows" ]; then
            PY="$(echo "$pythonLocation" | sed 's#\\\\#/#g')/python.exe"
          else
            PY="$pythonLocation/bin/python"
          fi
          echo "Using Python: $PY"
          "$PY" -m pip install --upgrade pip
          "$PY" -m pip install "pyinstaller==6.10.0"
          "$PY" - << 'PY'
          import sys
          print('Python:', sys.version)
          try:
              import PyInstaller
              print('PyInstaller:', PyInstaller.__version__)
          except Exception as e:
              print('PyInstaller import failed:', e)
              raise
          PY

      - name: Build rct-highscores (PyInstaller)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${RUNNER_OS:-}" = "Windows" ]; then
            PY="$(echo "$pythonLocation" | sed 's#\\\\#/#g')/python.exe"
          else
            PY="$pythonLocation/bin/python"
          fi
          "$PY" -m pyinstaller --onefile --name rct-highscores --paths src --hidden-import rct_progress.core build_highscores.py

      - name: Build rct-progress (PyInstaller)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${RUNNER_OS:-}" = "Windows" ]; then
            PY="$(echo "$pythonLocation" | sed 's#\\\\#/#g')/python.exe"
          else
            PY="$pythonLocation/bin/python"
          fi
          "$PY" -m pyinstaller --onefile --name rct-progress --paths src src/rct_progress/cli.py

      - name: Build macOS .app droplet (drag-and-drop)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          # Build a GUI .app that accepts dropped files as argv
          if [ "${RUNNER_OS:-}" = "Windows" ]; then
            PY="$(echo "$pythonLocation" | sed 's#\\\\#/#g')/python.exe"
          else
            PY="$pythonLocation/bin/python"
          fi
          "$PY" -m pyinstaller --windowed --name "RCT Highscores Droplet" --paths src --hidden-import rct_progress.core build_highscores.py
          # Zip the .app bundle for distribution
          mkdir -p artifacts
          ditto -c -k --sequesterRsrc --keepParent "dist/RCT Highscores Droplet.app" "artifacts/RCT-Highscores-Droplet-macos-x64.zip"

      - name: Build Linux AppImage (drag-and-drop via .desktop %F) [temporarily disabled]
        if: runner.os == 'Linux' && false
        shell: bash
        run: |
          set -euo pipefail
          echo "Skipping AppImage build for this run."
          exit 0

      - name: Prepare artifacts
        shell: bash
        run: |
          set -e
          mkdir -p artifacts
          case "${{ runner.os }}" in
            Windows) PLATFORM=win-x64 ;;
            Linux) PLATFORM=linux-x64 ;;
            macOS) PLATFORM=macos-x64 ;;
            *) PLATFORM=unknown ;;
          esac
          echo "Platform: $PLATFORM"
          for bin in rct-highscores rct-progress; do
            for path in dist/$bin*; do
              [ ! -e "$path" ] && continue
              fname="$(basename "$path")"
              name="$fname"; ext=""
              if [[ "$fname" == *.exe ]]; then
                ext=".exe"; name="${fname%.exe}"
              fi
              mv "$path" "artifacts/${name}-${PLATFORM}${ext}"
            done
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rct_progress-${{ github.ref_name }}-${{ runner.os }}
          path: artifacts/*

  package:
    name: Build Python sdist+wheel
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build backend
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Build sdist+wheel
        run: |
          python -m build

      - name: Upload dists
        uses: actions/upload-artifact@v4
        with:
          name: rct_progress-${{ github.ref_name }}-python-dists
          path: |
            dist/*.whl
            dist/*.tar.gz

  release:
    name: Attach to GitHub Release
    needs: [build, package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-artifacts

      - name: Generate release notes from CHANGELOG.md
        shell: bash
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          VERSION="${TAG_NAME#v}"
          echo "Preparing release notes for v$VERSION"
          # Extract the section for this version (from '## <version>' to the next '## ')
          awk -v ver="$VERSION" '
            $0 ~ "^## " ver {flag=1; next} 
            flag && /^## / {flag=0} 
            flag {print}
          ' CHANGELOG.md > .ch_section || true

          # Fallback if nothing was extracted
          if [ ! -s .ch_section ]; then
            echo "No dedicated section for v$VERSION found in CHANGELOG.md; using a generic note." >&2
            echo "See CHANGELOG.md for details." > .ch_section
          fi

          REPO="${GITHUB_REPOSITORY}"
          # Dynamically build download links from artifacts to support new arches (e.g., macos-arm64)
          WINDOWS_ITEMS=""
          MACOS_ITEMS=""
          LINUX_ITEMS=""
          OTHER_ITEMS=""
          while IFS= read -r -d '' f; do
            base="$(basename "$f")"
            url="https://github.com/$REPO/releases/download/$TAG_NAME/$base"
            case "$base" in
              *win-*.exe)
                if [[ "$base" == rct-highscores-* ]]; then
                  WINDOWS_ITEMS+="  - rct-highscores: $url\n"
                elif [[ "$base" == rct-progress-* ]]; then
                  WINDOWS_ITEMS+="  - rct-progress: $url\n"
                else
                  WINDOWS_ITEMS+="  - $base: $url\n"
                fi
                ;;
              RCT-Highscores-Droplet-macos-*.zip)
                MACOS_ITEMS+="  - rct-highscores (.app droplet): $url\n"
                ;;
              *macos-*)
                if [[ "$base" == rct-highscores-* ]]; then
                  MACOS_ITEMS+="  - rct-highscores (CLI one-file): $url\n"
                elif [[ "$base" == rct-progress-* ]]; then
                  MACOS_ITEMS+="  - rct-progress (CLI one-file): $url\n"
                else
                  MACOS_ITEMS+="  - $base: $url\n"
                fi
                ;;
              RCT-Highscores-linux-*.AppImage)
                LINUX_ITEMS+="  - rct-highscores (AppImage): $url\n"
                ;;
              *linux-*)
                if [[ "$base" == rct-highscores-* ]]; then
                  LINUX_ITEMS+="  - rct-highscores (CLI one-file): $url\n"
                elif [[ "$base" == rct-progress-* ]]; then
                  LINUX_ITEMS+="  - rct-progress (CLI one-file): $url\n"
                else
                  LINUX_ITEMS+="  - $base: $url\n"
                fi
                ;;
              *)
                OTHER_ITEMS+="  - $base: $url\n"
                ;;
            esac
          done < <(find all-artifacts -type f -print0 2>/dev/null || true)

          {
            echo "What's new in v$VERSION"
            echo
            cat .ch_section
            echo
            echo "Downloads"
            if [ -n "$WINDOWS_ITEMS" ]; then
              echo "- Windows"
              printf "%b" "$WINDOWS_ITEMS"
            fi
            if [ -n "$MACOS_ITEMS" ]; then
              echo "- macOS"
              printf "%b" "$MACOS_ITEMS"
            fi
            if [ -n "$LINUX_ITEMS" ]; then
              echo "- Linux"
              printf "%b" "$LINUX_ITEMS"
            fi
            if [ -n "$OTHER_ITEMS" ]; then
              echo "- Other"
              printf "%b" "$OTHER_ITEMS"
            fi
          } > release_notes.md

      - name: Create/Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ github.token }}
          tag: ${{ github.ref_name }}
          name: rct_progress ${{ github.ref_name }}
          bodyFile: release_notes.md
          draft: false
          prerelease: false
          allowUpdates: true
          makeLatest: true
          removeArtifacts: false
          artifactContentType: application/octet-stream
          artifacts: |
            all-artifacts/**
